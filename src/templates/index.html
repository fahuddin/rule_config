<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Rule Maintenance</title>
    <style>
      :root{
        --bg:#ffffff;--card:#ffffff;--accent:#0f172a;--muted:#6b7280;--border:#e5e7eb;
        --soft:#f8fafc;--warn:#b45309;--good:#065f46;

        /* reasoning ui */
        --chip:#f1f5f9;
        --chipText:#0f172a;
        --shadow:0 10px 26px rgba(15, 23, 42, 0.10);
        --ring:0 0 0 3px rgba(15, 23, 42, 0.08);

        /* prettier accents */
        --gradA: rgba(15,23,42,0.10);
        --gradB: rgba(15,23,42,0.02);
        --okBg: rgba(6,95,70,0.08);
        --warnBg: rgba(180,83,9,0.08);
        --mutedBg: rgba(107,114,128,0.08);
      }
      html,body{height:100%}
      body{
        margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;
        background:var(--bg);color:#000;display:flex;align-items:flex-start;justify-content:center;padding:32px
      }
      .container{width:1020px;max-width:96%}
      .card{
        background:var(--card);border-radius:12px;padding:22px;
        box-shadow:0 6px 18px rgba(0,0,0,0.06);border:1px solid var(--border)
      }
      h1{margin:0 0 8px;font-size:20px}
      p.lead{margin:0 0 18px;color:var(--muted)}
      .grid{display:grid;grid-template-columns:1fr 420px;gap:20px;align-items:start}
      @media (max-width:920px){.grid{grid-template-columns:1fr}}
      .form-row{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:12px}
      label.field{font-size:0.85rem;color:var(--muted);display:block;margin-bottom:6px}
      select,input[type=text],textarea{
        padding:10px;border:1px solid var(--border);border-radius:8px;width:100%;box-sizing:border-box;
        background:#fff
      }
      textarea{resize:vertical}
      .section{background:#fff;padding:12px;border-radius:10px;border:1px solid var(--border)}
      .section h3{margin:0 0 8px;font-size:14px}
      .muted{color:var(--muted);font-size:0.9rem}
      .toolbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px}
      .pill{
        display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;
        border:1px solid var(--border);background:#fff;font-size:12px;color:#111
      }
      .pill strong{font-weight:600}
      .footer{display:flex;justify-content:space-between;align-items:center;margin-top:14px;gap:10px;flex-wrap:wrap}
      button{
        padding:10px 14px;border-radius:8px;border:1px solid var(--border);
        background:#fff;cursor:pointer
      }
      button.primary{background:var(--accent);color:#fff;border-color:transparent}
      button:disabled{opacity:.55;cursor:not-allowed}
      .row-actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
      .hint{background:var(--soft);border:1px dashed var(--border);padding:10px;border-radius:10px}
      .status{font-size:12px;color:var(--muted)}
      .status.ok{color:var(--good)}
      .status.warn{color:var(--warn)}
      .small{font-size:12px}
      .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

      /* =========================
         Reasoning UI (PRETTIER)
         ========================= */
      .reasoning-card{
        border:1px solid var(--border);
        border-radius:16px;
        padding:14px;
        background:
          radial-gradient(1200px 600px at 30% -10%, var(--gradA), transparent 55%),
          radial-gradient(900px 500px at 100% 0%, rgba(99,102,241,0.10), transparent 55%),
          linear-gradient(180deg, #ffffff 0%, #ffffff 65%, #fbfdff 100%);
        box-shadow:var(--shadow);
        overflow:hidden;
        position:relative;
      }
      .reasoning-card:before{
        content:"";
        position:absolute;
        inset:-1px;
        border-radius:16px;
        padding:1px;
        background:linear-gradient(135deg, rgba(15,23,42,0.12), rgba(99,102,241,0.10), rgba(15,23,42,0.06));
        -webkit-mask:
          linear-gradient(#000 0 0) content-box,
          linear-gradient(#000 0 0);
        -webkit-mask-composite:xor;
        mask-composite:exclude;
        pointer-events:none;
      }

      .reasoning-head{
        display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:10px;
      }
      .reasoning-title{display:flex;align-items:center;gap:10px}
      .badge-dot{
        width:12px;height:12px;border-radius:999px;
        background:linear-gradient(180deg, rgba(15,23,42,1), rgba(99,102,241,0.9));
        box-shadow:0 0 0 4px rgba(15,23,42,0.08);
      }
      .reasoning-title h3{margin:0;font-size:14px}
      .reasoning-sub{margin-top:3px;font-size:12px;color:var(--muted);line-height:1.35}

      .meta-row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:10px}
      .chip{
        display:inline-flex;align-items:center;gap:8px;
        padding:6px 10px;border-radius:999px;
        border:1px solid rgba(15,23,42,0.10);
        background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(241,245,249,0.9));
        font-size:12px;color:var(--chipText);
        box-shadow:0 1px 0 rgba(15,23,42,0.04);
      }
      .chip .k{color:var(--muted);font-weight:500}
      .chip .v{font-weight:700}

      .panel{
        border:1px solid rgba(15,23,42,0.10);
        border-radius:14px;
        padding:12px;
        background:rgba(255,255,255,0.92);
        box-shadow:0 6px 18px rgba(15,23,42,0.06);
        backdrop-filter:saturate(1.2) blur(6px);
      }
      .panel-header{
        display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;
      }
      .panel-header .label{
        font-size:11px;color:var(--muted);
        text-transform:uppercase;letter-spacing:.12em;
      }

      .right-actions{display:flex;align-items:center;gap:8px}
      .icon-btn{
        padding:7px 10px;border-radius:12px;
        border:1px solid rgba(15,23,42,0.12);
        background:linear-gradient(180deg, #fff, #f8fafc);
        font-size:12px;cursor:pointer;
        box-shadow:0 1px 0 rgba(15,23,42,0.04);
      }
      .icon-btn:hover{box-shadow:0 8px 18px rgba(15,23,42,0.08)}
      .icon-btn:focus{outline:none;box-shadow:var(--ring)}

      .tag{
        font-size:11px;padding:4px 9px;border-radius:999px;border:1px solid rgba(15,23,42,0.12);
        background:#fff;color:#111;
      }
      .tag.ok{border-color:rgba(6,95,70,0.25);background:var(--okBg);color:var(--good)}
      .tag.warn{border-color:rgba(180,83,9,0.25);background:var(--warnBg);color:var(--warn)}
      .tag.muted{background:var(--mutedBg);border-color:rgba(107,114,128,0.18);color:var(--muted)}

      .kv{
        display:grid;grid-template-columns: 140px 1fr;gap:8px 12px;
        font-size:12px;
      }
      .kv .k{color:var(--muted)}
      .kv .v{color:#111;min-width:0}

      .divider{
        height:1px;
        background:linear-gradient(90deg, transparent, rgba(15,23,42,0.12), transparent);
        margin:12px 0;
      }

      .progress{
        height:10px;border-radius:999px;background:rgba(15,23,42,0.06);
        overflow:hidden;border:1px solid rgba(15,23,42,0.10);
      }
      .progress > div{
        height:100%;
        width:0%;
        background:linear-gradient(90deg, rgba(15,23,42,0.95), rgba(99,102,241,0.85));
        border-radius:999px;
        transition:width .35s ease;
      }

      .timeline{
        position:relative;
        padding-left:22px;
      }
      .timeline:before{
        content:"";
        position:absolute;left:10px;top:2px;bottom:2px;
        width:2px;background:linear-gradient(180deg, rgba(15,23,42,0.18), rgba(99,102,241,0.10), rgba(15,23,42,0.06));
        border-radius:999px;
      }

      details.step{
        border:1px solid rgba(15,23,42,0.10);
        border-radius:14px;
        padding:10px 10px;
        background:linear-gradient(180deg, rgba(255,255,255,0.96), rgba(248,250,252,0.96));
        margin-bottom:10px;
        box-shadow:0 6px 18px rgba(15,23,42,0.06);
      }
      details.step[open]{box-shadow:0 10px 24px rgba(15,23,42,0.10)}
      summary.step-summary{
        list-style:none;
        cursor:pointer;
        display:flex;align-items:center;justify-content:space-between;gap:10px;
      }
      summary.step-summary::-webkit-details-marker{display:none}
      .step-left{display:flex;align-items:center;gap:10px;min-width:0}
      .node{
        width:14px;height:14px;border-radius:999px;background:#fff;border:2px solid rgba(15,23,42,0.22);
        box-shadow:0 0 0 4px rgba(15,23,42,0.05);
        position:relative;
        flex:0 0 auto;
        margin-left:-22px;
      }
      .node.ok{border-color:rgba(6,95,70,0.55)}
      .node.run{border-color:rgba(180,83,9,0.55)}
      .node.skip{border-color:rgba(107,114,128,0.45)}
      .node.ok:after,.node.run:after,.node.skip:after{
        content:"";
        position:absolute;inset:3px;border-radius:999px;
        background:rgba(15,23,42,0.06);
      }
      .node.ok:after{background:rgba(6,95,70,0.18)}
      .node.run:after{background:rgba(180,83,9,0.18)}
      .node.skip:after{background:rgba(107,114,128,0.16)}

      .step-name{
        font-size:13px;font-weight:750;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      }
      .step-desc{
        font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      }
      .step-meta{display:flex;align-items:center;gap:8px;flex:0 0 auto}

      .step-body{margin-top:10px;border-top:1px solid rgba(15,23,42,0.08);padding-top:10px}

      .pre{
        margin-top:10px;
        background:linear-gradient(180deg, #0b1220 0%, #0b1220 100%);
        border:1px solid rgba(148,163,184,0.25);
        border-radius:14px;
        padding:10px;
        font-size:12px;
        overflow:auto;
        max-height:220px;
        box-shadow:inset 0 1px 0 rgba(255,255,255,0.06);
      }
      .pre code{
        font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
        color:#e5e7eb;
      }

      .final{
        white-space:pre-wrap;
        line-height:1.5;
        font-size:12.5px;
        color:#0b1220;
      }
      .tiny{font-size:11px;color:var(--muted)}

      /* small polish */
      .panel + .panel { margin-top:12px; }
      .panel-header .tiny{opacity:.9}
    </style>
  </head>

  <body>
    <div class="container">
      <div class="card">
        <div class="toolbar">
          <div>
            <h1 style="margin:0">Rule Maintenance</h1>
            <p class="lead">Browse rules from Redis, edit details, and run agent modes to generate outputs.</p>
          </div>
          <div class="row-actions">
            <span class="pill"><strong>API</strong> <span class="mono">/api/rules</span></span>
            <button id="refreshBtn" title="Reload from server">Refresh</button>
          </div>
        </div>

        <div class="grid">
          <!-- LEFT -->
          <div>
            <div class="section">
              <h3>Application / Module</h3>
              <div class="form-row">
                <div>
                  <label class="field">Application</label>
                  <select id="appSelect"></select>
                </div>
                <div>
                  <label class="field">Sub-module</label>
                  <select id="subSelect"></select>
                </div>
              </div>

              <h3 style="margin-top:12px">Rule Type &amp; Rule</h3>
              <div class="form-row">
                <div>
                  <label class="field">Rule Type</label>
                  <select id="typeSelect"></select>
                </div>
                <div>
                  <label class="field">Rule Name</label>
                  <select id="ruleSelect"></select>
                </div>
              </div>
            </div>

            <div style="margin-top:12px" class="section">
              <h3>Rule Details</h3>

              <div class="form-row" style="grid-template-columns:1fr 1fr">
                <div>
                  <label class="field">Rule ID</label>
                  <input id="ruleId" type="text" disabled />
                </div>
                <div>
                  <label class="field">Rule Name</label>
                  <input id="ruleName" type="text" disabled />
                </div>
              </div>

              <div style="margin-bottom:8px">
                <label class="field">Rule Definition</label>
                <textarea id="ruleDef" rows="7" placeholder="Rule definition (MVEL / expression)"></textarea>
              </div>

              <div style="margin-bottom:8px">
                <label class="field">Rule Description / Output</label>
                <textarea id="ruleDesc" rows="4" placeholder="Agent output or saved description"></textarea>
              </div>

              <div class="footer">
                <div>
                  <div class="status" id="statusText">Ready.</div>
                  <div class="small muted">
                    Save writes only <span class="mono">rule_desc</span> via
                    <span class="mono">POST /api/rules/&lt;id&gt;/description</span>.
                  </div>
                </div>

                <div class="row-actions">
                  <button class="primary" id="saveBtn">Save Description</button>

                  <div style="min-width:180px">
                    <label class="field" style="margin-bottom:6px">Agent mode</label>
                    <select id="modeSelect">
                      <option value="explain">explain</option>
                      <option value="diff">diff</option>
                      <option value="verify">verify</option>
                      <option value="tests">tests</option>
                    </select>
                  </div>

                  <button id="agentBtn">Run Agent</button>
                  <button id="regenerateBtn" title="Force regenerate (no cache)">Regenerate</button>
                </div>
              </div>
            </div>
          </div>

          <!-- RIGHT -->
          <div>
            <!-- Reasoning UI + Selected Context -->
            <div class="reasoning-card section" style="padding:14px">
              <div class="reasoning-head">
                <div class="reasoning-title">
                  <span class="badge-dot" aria-hidden="true"></span>
                  <div>
                    <h3 style="margin:0">Reasoning Trace</h3>
                    <div class="reasoning-sub">
                      Timeline + metadata for the latest agent run. Selected context is shown here too.
                    </div>
                  </div>
                </div>

                <div class="right-actions">
                  <button class="icon-btn" id="toggleAllBtn" title="Expand/collapse all">Expand all</button>
                  <button class="icon-btn" id="copyFinalBtn" title="Copy final output">Copy final</button>
                </div>
              </div>

              <!-- Meta chips -->
              <div class="meta-row" id="traceMetaRow"></div>

              <!-- Selected context -->
              <div class="panel" style="margin-top:12px">
                <div class="panel-header">
                  <div class="label">Selected context</div>
                  <span class="tag muted" id="ctxStatusPill">—</span>
                </div>

                <div class="kv" style="grid-template-columns: 120px 1fr">
                  <div class="k">Application</div><div class="v" id="ctxApp2">-</div>
                  <div class="k">Sub-module</div><div class="v" id="ctxSub2">-</div>
                  <div class="k">Rule Type</div><div class="v" id="ctxType2">-</div>
                  <div class="k">Rule Name</div><div class="v" id="ctxName2">-</div>
                </div>
              </div>

              <div class="divider"></div>

              <!-- Progress -->
              <div class="panel">
                <div class="panel-header">
                  <div class="label">Run progress</div>
                  <div class="tiny" id="runDurationText">—</div>
                </div>
                <div class="progress" aria-label="run progress"><div id="progressBar"></div></div>
                <div class="tiny" style="margin-top:8px" id="runSummaryText">—</div>
              </div>

              <!-- Timeline -->
              <div class="panel">
                <div class="panel-header">
                  <div class="label">Timeline</div>
                  <div class="tiny" id="stepCountText">—</div>
                </div>
                <div class="timeline" id="timeline"></div>
              </div>

              <!-- Final output -->
              <div class="panel">
                <div class="panel-header">
                  <div class="label">Final output</div>
                  <span class="tag muted" id="finalTag">—</span>
                </div>
                <div class="final" id="finalOutput">No trace loaded.</div>
              </div>
            </div>

            <!-- Agent Modes -->
            <div style="margin-top:12px" class="section">
              <h3>Agent Modes</h3>
              <div class="hint muted">
                <div><strong>explain</strong>: user-friendly description of the rule.</div>
                <div style="margin-top:6px"><strong>diff</strong>: highlight changes between current vs saved (if your agent supports it).</div>
                <div style="margin-top:6px"><strong>verify</strong>: sanity-check and return issues/suggestions.</div>
                <div style="margin-top:6px"><strong>tests</strong>: propose test cases for the rule.</div>
                <div style="margin-top:10px" class="small">
                  Calls <span class="mono">POST /api/generate-description</span> with JSON
                  <span class="mono">{ definition, model, force, mode }</span>.
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Elements
      const appSelect = document.getElementById('appSelect');
      const subSelect = document.getElementById('subSelect');
      const typeSelect = document.getElementById('typeSelect');
      const ruleSelect = document.getElementById('ruleSelect');

      const ruleId = document.getElementById('ruleId');
      const ruleName = document.getElementById('ruleName');
      const ruleDef = document.getElementById('ruleDef');
      const ruleDesc = document.getElementById('ruleDesc');

      const modeSelect = document.getElementById('modeSelect');
      const saveBtn = document.getElementById('saveBtn');
      const regenerateBtn = document.getElementById('regenerateBtn');
      const agentBtn = document.getElementById('agentBtn');
      const refreshBtn = document.getElementById('refreshBtn');
      const statusText = document.getElementById('statusText');

      // Selected context
      const ctxApp2 = document.getElementById('ctxApp2');
      const ctxSub2 = document.getElementById('ctxSub2');
      const ctxType2 = document.getElementById('ctxType2');
      const ctxName2 = document.getElementById('ctxName2');
      const ctxStatusPill = document.getElementById('ctxStatusPill');

      // Reasoning UI elements
      const traceMetaRow = document.getElementById('traceMetaRow');
      const timelineEl = document.getElementById('timeline');
      const finalOutputEl = document.getElementById('finalOutput');
      const progressBarEl = document.getElementById('progressBar');
      const runDurationText = document.getElementById('runDurationText');
      const runSummaryText = document.getElementById('runSummaryText');
      const stepCountText = document.getElementById('stepCountText');
      const finalTag = document.getElementById('finalTag');
      const toggleAllBtn = document.getElementById('toggleAllBtn');
      const copyFinalBtn = document.getElementById('copyFinalBtn');

      // Data
      let allRules = [];
      let selectedRule = null;
      let currentGenId = 0;

      const model = "llama3.1"; // matches your backend default

      // Demo trace (only used on first load if no real trace yet)
      const DEMO_TRACE = {
        "run_id": "1d3a7563-c7b3-4482-9891-55d46037dbce",
        "started_at": 1770353219.9745023,
        "ended_at": 1770353248.9037688,
        "steps": [
          { "name":"start","ts":1770353219.9745092,"data":{"status":"ok","summary":"Run started","mode":"explain","model":"llama3.1","inputs":1}},
          { "name":"plan:set","ts":1770353219.9745152,"data":{"status":"ok","summary":"Plan created","goal":"explain","steps":["parse","retrieve_context","explain","reflect","rewrite"]}},
          { "name":"parse","ts":1770353219.9827738,"data":{"status":"ok","summary":"Parsed rule ...","span_id":"ce2a1e31-63dc-4736-8a43-38af6840ee31","rule_hash":"19f44e...","branches":1,"outputs":[]}},
          { "name":"action:end","ts":1770353219.9827778,"data":{"status":"ok","summary":"Parse complete","span_id":"ce2a1e31-63dc-4736-8a43-38af6840ee31"}},
          { "name":"action:start","ts":1770353219.9840477,"data":{"status":"running","summary":"Retrieve context","span_id":"d21f70f8-30eb-4034-8243-818cfe414bb5"}},
          { "name":"retrieve_context","ts":1770353219.9840517,"data":{"status":"ok","summary":"Context assembled","span_id":"d21f70f8-30eb-4034-8243-818cfe414bb5","context_chars":22095}},
          { "name":"action:end","ts":1770353219.9840536,"data":{"status":"ok","summary":"Context retrieval complete","span_id":"d21f70f8-30eb-4034-8243-818cfe414bb5"}},
          { "name":"explain","ts":1770353240.4733486,"data":{"status":"ok","summary":"Generated explanation","span_id":"d21f70f8-30eb-4034-8243-818cfe414bb5","english_chars":1377,"cache":"miss"}},
          { "name":"action:end","ts":1770353240.4733531,"data":{"status":"ok","summary":"Explain complete","span_id":"d21f70f8-30eb-4034-8243-818cfe414bb5"}},
          { "name":"reflect","ts":1770353248.8878334,"data":{"issues":3}},
          { "name":"rewrite_skipped","ts":1770353248.9034898,"data":{"ok":true}},
          { "name":"rewrite_skipped","ts":1770353248.9034965,"data":{"status":"skipped","summary":"Rewrite not needed","ok":true}}
        ],
        "final_output":"(demo) final output…"
      };

      // Helpers
      const uniq = (arr) => [...new Set(arr.filter(v => String(v || '').trim() !== ''))];

      function setStatus(msg, kind="") {
        statusText.className = "status " + (kind || "");
        statusText.textContent = msg;
      }

      function setOptions(selectEl, values, preferredValue = null) {
        selectEl.innerHTML = '';
        values.forEach(v => {
          const opt = document.createElement('option');
          opt.value = v;
          opt.textContent = v;
          selectEl.appendChild(opt);
        });
        if (preferredValue && values.includes(preferredValue)) {
          selectEl.value = preferredValue;
        } else if (values.length) {
          selectEl.selectedIndex = 0;
        }
      }

      function updateContext() {
        const app = appSelect.value || '-';
        const sub = subSelect.value || '-';
        const typ = typeSelect.value || '-';
        const nam = ruleSelect.value || '-';

        if (ctxApp2) ctxApp2.textContent = app;
        if (ctxSub2) ctxSub2.textContent = sub;
        if (ctxType2) ctxType2.textContent = typ;
        if (ctxName2) ctxName2.textContent = nam;

        if (ctxStatusPill) {
          const ok = !!(selectedRule && selectedRule.rule_id);
          ctxStatusPill.className = "tag " + (ok ? "ok" : "muted");
          ctxStatusPill.textContent = ok ? "loaded" : "none";
        }
      }

      function getFilteredRules() {
        const app = appSelect.value;
        const sub = subSelect.value;
        const typ = typeSelect.value;
        return allRules.filter(r =>
          (!app || r.application === app) &&
          (!sub || r.sub_module === sub) &&
          (!typ || r.rule_type === typ)
        );
      }

      function repopulateSelectors() {
        const prevApp = appSelect.value;
        const prevSub = subSelect.value;
        const prevType = typeSelect.value;
        const prevName = ruleSelect.value;

        const apps = uniq(allRules.map(r => r.application));
        setOptions(appSelect, apps, prevApp);

        const subs = uniq(allRules
          .filter(r => r.application === appSelect.value)
          .map(r => r.sub_module)
        );
        setOptions(subSelect, subs, prevSub);

        const types = uniq(allRules
          .filter(r => r.application === appSelect.value && r.sub_module === subSelect.value)
          .map(r => r.rule_type)
        );
        setOptions(typeSelect, types, prevType);

        const names = uniq(getFilteredRules().map(r => r.rule_name));
        setOptions(ruleSelect, names, prevName);

        updateContext();
      }

      function selectCurrentRule() {
        const name = ruleSelect.value;
        const candidates = getFilteredRules();
        selectedRule = candidates.find(r => r.rule_name === name) || null;

        if (!selectedRule) {
          ruleId.value = '';
          ruleName.value = '';
          ruleDef.value = '';
          ruleDesc.value = '';
          updateContext();
          setStatus("No rule selected.", "warn");
          return;
        }

        ruleId.value = selectedRule.rule_id || '';
        ruleName.value = selectedRule.rule_name || '';
        ruleDef.value = selectedRule.rule_def || '';
        ruleDesc.value = selectedRule.rule_desc || '';

        updateContext();
        setStatus("Loaded rule from Redis.", "ok");

        // Auto-generate description if missing
        if (ruleDef.value.trim() && !ruleDesc.value.trim()) {
          generateAgentOutput(ruleDef.value, false, "explain");
        }
      }

      async function loadRulesFromServer() {
        setStatus("Loading rules...", "");
        const res = await fetch('/api/rules');
        const data = await res.json();
        allRules = (data && data.rules) ? data.rules : [];
        setStatus(`Loaded ${allRules.length} rules.`, "ok");
      }

      // ===== Reasoning UI rendering =====
      function fmtSeconds(s) {
        if (!isFinite(s)) return "—";
        if (s < 1) return `${Math.round(s*1000)}ms`;
        if (s < 60) return `${s.toFixed(2)}s`;
        const m = Math.floor(s/60);
        const r = (s - m*60);
        return `${m}m ${r.toFixed(0)}s`;
      }

      function statusTag(status) {
        const s = String(status || "").toLowerCase();
        if (s === "ok" || s === "success") return { cls:"ok", txt:"ok" };
        if (s === "running") return { cls:"warn", txt:"running" };
        if (s === "skipped") return { cls:"muted", txt:"skipped" };
        if (s === "failed" || s === "error") return { cls:"warn", txt:"failed" };
        if (!s) return { cls:"muted", txt:"—" };
        return { cls:"muted", txt:s };
      }

      function nodeClass(status) {
        const s = String(status || "").toLowerCase();
        if (s === "ok" || s === "success") return "node ok";
        if (s === "running") return "node run";
        if (s === "skipped") return "node skip";
        if (s === "failed" || s === "error") return "node run";
        return "node";
      }

      function safeJson(obj) {
        try { return JSON.stringify(obj, null, 2); } catch { return String(obj); }
      }

      function escapeHtml(str) {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function buildMetaChips(trace) {
        traceMetaRow.innerHTML = "";

        const started = trace?.started_at;
        const ended = trace?.ended_at;
        const dur = (isFinite(started) && isFinite(ended)) ? (ended - started) : NaN;

        const first = (trace?.steps || [])[0]?.data || {};
        const mode = first.mode || "—";
        const modelName = first.model || "—";

        const chips = [
          ["Run", trace?.run_id ? String(trace.run_id).slice(0, 8) + "…" : "—"],
          ["Mode", mode],
          ["Model", modelName],
          ["Steps", (trace?.steps || []).length],
          ["Duration", fmtSeconds(dur)]
        ];

        chips.forEach(([k,v]) => {
          const el = document.createElement("span");
          el.className = "chip";
          el.innerHTML = `<span class="k">${escapeHtml(k)}</span> <span class="v">${escapeHtml(v)}</span>`;
          traceMetaRow.appendChild(el);
        });
      }

      function buildProgress(trace) {
        const steps = trace?.steps || [];
        const total = steps.length || 1;

        const okish = steps.filter(s => {
          const st = String(s?.data?.status || "").toLowerCase();
          return st === "ok" || st === "success";
        }).length;

        const pct = Math.max(0, Math.min(100, Math.round((okish / total) * 100)));
        progressBarEl.style.width = pct + "%";

        const started = trace?.started_at;
        const ended = trace?.ended_at;
        const dur = (isFinite(started) && isFinite(ended)) ? (ended - started) : NaN;

        runDurationText.textContent = `Duration: ${fmtSeconds(dur)}`;

        const startSummary = steps[0]?.data?.summary ? `Start: ${steps[0].data.summary}` : "—";
        const reflect = steps.find(s => s?.name === "reflect");
        const issues = reflect?.data?.issues != null ? ` • Issues: ${reflect.data.issues}` : "";
        runSummaryText.textContent = startSummary + issues;
      }

      function buildTimeline(trace) {
        const steps = trace?.steps || [];
        stepCountText.textContent = `${steps.length} step${steps.length === 1 ? "" : "s"}`;
        timelineEl.innerHTML = "";

        steps.forEach((s, idx) => {
          const name = s?.name ?? `step_${idx}`;
          const data = s?.data || {};
          const summary = data.summary || "";
          const tag = statusTag(data.status ?? (data.ok === true ? "ok" : data.ok === false ? "warn" : ""));
          const node = nodeClass(data.status ?? (data.ok === true ? "ok" : data.ok === false ? "warn" : ""));

          const details = document.createElement("details");
          details.className = "step";
          details.open = idx < 2;

          const sum = document.createElement("summary");
          sum.className = "step-summary";

          const left = document.createElement("div");
          left.className = "step-left";
          left.innerHTML = `
            <span class="${node}" aria-hidden="true"></span>
            <div style="min-width:0">
              <div class="step-name">${escapeHtml(name)}</div>
              <div class="step-desc">${escapeHtml(summary || "—")}</div>
            </div>
          `;

          const right = document.createElement("div");
          right.className = "step-meta";
          right.innerHTML = `<span class="tag ${tag.cls}">${escapeHtml(tag.txt)}</span>`;

          const body = document.createElement("div");
          body.className = "step-body";

          const kv = document.createElement("div");
          kv.className = "kv";
          kv.innerHTML = `
            <div class="k">timestamp</div><div class="v">${escapeHtml(String(s.ts ?? "—"))}</div>
            <div class="k">summary</div><div class="v">${escapeHtml(summary || "—")}</div>
          `;

          const pre = document.createElement("div");
          pre.className = "pre";
          pre.innerHTML = `<code>${escapeHtml(safeJson(data))}</code>`;

          body.appendChild(kv);
          body.appendChild(pre);

          sum.appendChild(left);
          sum.appendChild(right);

          details.appendChild(sum);
          details.appendChild(body);

          timelineEl.appendChild(details);
        });
      }

      function renderTrace(trace) {
        if (!trace) return;

        buildMetaChips(trace);
        buildProgress(trace);
        buildTimeline(trace);

        const out = (trace.final_output || trace.output || "").trim();
        finalOutputEl.textContent = out || "—";

        const last = (trace.steps || []).slice().reverse().find(s => s?.data?.status || s?.data?.ok != null);
        const st = last?.data?.status ?? (last?.data?.ok === true ? "ok" : last?.data?.ok === false ? "warn" : "—");
        const tg = statusTag(st);

        finalTag.className = `tag ${tg.cls}`;
        finalTag.textContent = tg.txt;
      }

      // UI actions
      let allExpanded = false;
      toggleAllBtn.addEventListener("click", () => {
        const nodes = timelineEl.querySelectorAll("details.step");
        allExpanded = !allExpanded;
        nodes.forEach(d => d.open = allExpanded);
        toggleAllBtn.textContent = allExpanded ? "Collapse all" : "Expand all";
      });

      copyFinalBtn.addEventListener("click", async () => {
        const text = finalOutputEl.textContent || "";
        try {
          await navigator.clipboard.writeText(text);
          copyFinalBtn.textContent = "Copied!";
          setTimeout(() => (copyFinalBtn.textContent = "Copy final"), 900);
        } catch {
          alert("Copy failed (clipboard not available).");
        }
      });

      // ===== Trace update fix (NEW) =====
      let hasRealTrace = false;

      function makePendingTrace(modeToUse) {
        const now = Date.now() / 1000;
        return {
          run_id: "running…",
          started_at: now,
          ended_at: now,
          steps: [
            { name: "start", ts: now, data: { status: "running", summary: "Run started", mode: modeToUse, model, inputs: 1 } },
            { name: "pending", ts: now + 0.01, data: { status: "running", summary: "Waiting for server response…" } }
          ],
          final_output: ""
        };
      }

      function normalizeTrace(trace) {
        if (!trace || typeof trace !== "object") return null;
        if (!Array.isArray(trace.steps)) trace.steps = [];
        return trace;
      }

      // ===== Agent call (follows YOUR Flask routes) =====
      function generateAgentOutput(definition, force=false, modeOverride=null) {
        if (!definition || !definition.trim()) return;

        const genId = ++currentGenId;
        const modeToUse = modeOverride || modeSelect.value || "explain";

        // Immediately show a "running" trace so timeline updates instantly
        renderTrace(makePendingTrace(modeToUse));
        finalOutputEl.textContent = "Running…";
        finalTag.className = "tag warn";
        finalTag.textContent = "running";

        ruleDesc.value = force ? "Regenerating..." : "Generating...";
        regenerateBtn.disabled = true;
        agentBtn.disabled = true;

        setStatus(`Agent running in "${modeToUse}" mode...`, "");

        fetch(`/api/generate-description`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mode: modeToUse, definition, model, force })
        })
        .then(async (r) => {
          let data = null;
          try { data = await r.json(); } catch { data = {}; }
          if (!r.ok) {
            const msg = (data && (data.error || data.message)) ? (data.error || data.message) : `HTTP ${r.status}`;
            throw new Error(msg);
          }
          return data;
        })
        .then(data => {
          if (genId !== currentGenId) return;

          const out = (data && data.description) ? String(data.description).trim() : '';
          ruleDesc.value = out;

          if (selectedRule) selectedRule.rule_desc = out;

          setStatus("Agent finished.", "ok");

          // Use the real trace if present; do NOT overwrite with demo after real traces exist
          const trace = normalizeTrace(data?.trace);
          if (trace) {
            hasRealTrace = true;
            renderTrace(trace);
          } else if (!hasRealTrace) {
            renderTrace(DEMO_TRACE);
          }
        })
        .catch(err => {
          if (genId !== currentGenId) return;
          console.warn('Agent call failed:', err);

          ruleDesc.value = '';
          setStatus("Agent failed. Check server logs.", "warn");

          // Show failure in trace UI (instead of demo)
          const now = Date.now() / 1000;
          renderTrace({
            run_id: "failed",
            started_at: now,
            ended_at: now,
            steps: [
              { name: "error", ts: now, data: { status: "failed", summary: String(err?.message || err || "Unknown error") } }
            ],
            final_output: ""
          });
          finalOutputEl.textContent = String(err?.message || err || "Unknown error");
          finalTag.className = "tag warn";
          finalTag.textContent = "failed";
        })
        .finally(() => {
          regenerateBtn.disabled = false;
          agentBtn.disabled = false;
        });
      }

      // Events: selectors
      appSelect.addEventListener('change', () => { repopulateSelectors(); selectCurrentRule(); });
      subSelect.addEventListener('change', () => { repopulateSelectors(); selectCurrentRule(); });
      typeSelect.addEventListener('change', () => { repopulateSelectors(); selectCurrentRule(); });
      ruleSelect.addEventListener('change', () => { selectCurrentRule(); });

      // Refresh
      refreshBtn.addEventListener('click', async () => {
        await loadRulesFromServer();
        repopulateSelectors();
        selectCurrentRule();
      });

      // Save description
      saveBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        if (!selectedRule || !selectedRule.rule_id) {
          alert('No rule selected.');
          return;
        }

        const desc = (ruleDesc.value || '').trim();
        if (!desc) {
          alert('Description/output is empty.');
          return;
        }

        setStatus("Saving description...", "");
        const resp = await fetch(`/api/rules/${encodeURIComponent(selectedRule.rule_id)}/description`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ description: desc })
        });

        if (resp.ok) {
          setStatus("Saved to Redis.", "ok");
          selectedRule.rule_desc = desc;
        } else {
          const err = await resp.json().catch(() => ({}));
          setStatus("Save failed.", "warn");
          alert('Save failed: ' + (err.error || resp.status));
        }
      });

      // Init
      (async function init() {
        await loadRulesFromServer();
        repopulateSelectors();
        selectCurrentRule();
        renderTrace(DEMO_TRACE);
      })();

      // Hook run/regenerate
      document.getElementById('agentBtn').addEventListener('click', (e) => {
        e.preventDefault();
        if (!ruleDef.value || !ruleDef.value.trim()) return;
        generateAgentOutput(ruleDef.value, false, modeSelect.value);
      });

      document.getElementById('regenerateBtn').addEventListener('click', (e) => {
        e.preventDefault();
        if (!ruleDef.value || !ruleDef.value.trim()) return;
        generateAgentOutput(ruleDef.value, true, modeSelect.value);
      });
    </script>
  </body>
</html>
