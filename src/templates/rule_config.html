<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Rule Configuration</title>
    <style>
      :root{--bg:#ffffff;--card:#ffffff;--accent:#0f172a;--muted:#6b7280;--border:#e5e7eb}
      html,body{height:100%}
      body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:#000;display:flex;align-items:flex-start;justify-content:center;padding:32px}
      .container{width:980px;max-width:96%}
      .card{background:var(--card);border-radius:12px;padding:22px;box-shadow:0 6px 18px rgba(0,0,0,0.06);border:1px solid var(--border)}
      h1{margin:0 0 8px;font-size:20px}
      p.lead{margin:0 0 18px;color:var(--muted)}

      .grid{display:grid;grid-template-columns:1fr 420px;gap:20px;align-items:start}
      @media (max-width:920px){.grid{grid-template-columns:1fr}}

      .form-row{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:12px}
      label.field{font-size:0.85rem;color:var(--muted);display:block;margin-bottom:6px}
      select,input[type=text],textarea{padding:10px;border:1px solid var(--border);border-radius:8px;width:100%;box-sizing:border-box}

      .section{background:#fff;padding:12px;border-radius:10px;border:1px solid var(--border)}
      .section h3{margin:0 0 8px;font-size:14px}
      .muted{color:var(--muted);font-size:0.9rem}

      .footer{display:flex;justify-content:space-between;align-items:center;margin-top:14px}
      button.primary{background:var(--accent);color:#fff;padding:10px 16px;border-radius:8px;border:0;cursor:pointer}
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
          <h1 style="margin:0">Rule Configuration</h1>
          <div>
            <a href="/" style="text-decoration:none"><button style="padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:#fff;cursor:pointer">Upload</button></a>
          </div>
        </div>
        <p class="lead">Select application/module, rule type and name to edit rule details.</p>

        <div class="grid">
          <div>
            <div class="section">
              <h3>Application / Module</h3>
              <div class="form-row">
                <div>
                  <label class="field">Application</label>
                  <select id="appSelect">
                    <option value="IFL">IFL</option>
                  </select>
                </div>
                <div>
                  <label class="field">Sub-module</label>
                  <select id="subSelect">
                    <option value="Cash">Cash</option>
                    <option value="Payment">Payment</option>
                    <option value="Transfer">Transfer</option>
                  </select>
                </div>
              </div>

              <h3 style="margin-top:12px">Rule Type &amp; Rule</h3>
              <div class="form-row">
                <div>
                  <label class="field">Rule Type</label>
                  <select id="typeSelect">
                    <option value="ReferenceFileValidation">ReferenceFileValidation</option>
                    <option value="AccountsValidation">AccountsValidation</option>
                  </select>
                </div>
                <div>
                  <label class="field">Rule Name</label>
                  <select id="ruleSelect">
                  </select>
                </div>
              </div>
            </div>

            <div style="margin-top:12px" class="section">
              <h3>Rule Details</h3>
              <div style="margin-bottom:8px">
                <label class="field">Rule Definition</label>
                <textarea id="ruleDef" rows="6" placeholder="Enter or edit rule definition"></textarea>
              </div>
              <div>
                <label class="field">Rule Description</label>
                <textarea id="ruleDesc" rows="3" placeholder="Friendly description of the rule"></textarea>
              </div>

              <div class="footer">
                <div class="muted">Changes are local in this demo.</div>
                <div>
                  <button class="primary" id="saveBtn">Save</button>
                  <button id="regenerateBtn" style="margin-left:8px">Regenerate</button>
                </div>
              </div>
            </div>
          </div>

          <div>
            <div class="section">
              <h3>Selected Context</h3>
              <div style="margin-top:8px">
                <p><strong>Application:</strong> <span id="ctxApp">IFL</span></p>
                <p><strong>Sub-module:</strong> <span id="ctxSub">Cash</span></p>
                <p><strong>Rule Type:</strong> <span id="ctxType">ReferenceFileValidation</span></p>
                <p><strong>Rule Name:</strong> <span id="ctxName">-</span></p>
              </div>
            </div>

            <div style="margin-top:12px" class="section">
              <h3>Help</h3>
              <div class="muted">Rule lists are filtered by the selected Rule Type. Edit definition and description, then click Save.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
  // Elements
  const typeSelect = document.getElementById('typeSelect');
  const ruleSelect = document.getElementById('ruleSelect');
  const ctxApp = document.getElementById('ctxApp');
  const ctxSub = document.getElementById('ctxSub');
  const ctxType = document.getElementById('ctxType');
  const ctxName = document.getElementById('ctxName');
  const appSelect = document.getElementById('appSelect');
  const subSelect = document.getElementById('subSelect');
  const ruleDef = document.getElementById('ruleDef');
  const ruleDesc = document.getElementById('ruleDesc');
  const saveBtn = document.getElementById('saveBtn');
  const regenerateBtn = document.getElementById('regenerateBtn');

  // Local cache of Redis rules
  let allRules = [];           // array of objects from /api/rules
  let selectedRule = null;     // currently selected rule object
  let currentGenId = 0;        // prevent race-condition updates

  // Helpers
  const uniq = (arr) => [...new Set(arr.filter(v => String(v || '').trim() !== ''))];

  function setOptions(selectEl, values, preferredValue = null) {
    selectEl.innerHTML = '';
    values.forEach(v => {
      const opt = document.createElement('option');
      opt.value = v;
      opt.textContent = v;
      selectEl.appendChild(opt);
    });
    if (preferredValue && values.includes(preferredValue)) {
      selectEl.value = preferredValue;
    } else if (values.length) {
      selectEl.selectedIndex = 0;
    }
  }

  function updateContext() {
    ctxApp.textContent = appSelect.value || '-';
    ctxSub.textContent = subSelect.value || '-';
    ctxType.textContent = typeSelect.value || '-';
    ctxName.textContent = ruleSelect.value || '-';
  }

  function getFilteredRules() {
    const app = appSelect.value;
    const sub = subSelect.value;
    const typ = typeSelect.value;
    return allRules.filter(r =>
      (!app || r.application === app) &&
      (!sub || r.sub_module === sub) &&
      (!typ || r.rule_type === typ)
    );
  }

  function repopulateSelectors() {
    const prevApp = appSelect.value;
    const prevSub = subSelect.value;
    const prevType = typeSelect.value;
    const prevName = ruleSelect.value;

    // Applications
    const apps = uniq(allRules.map(r => r.application));
    setOptions(appSelect, apps, prevApp);

    // Sub-modules for selected application
    const subs = uniq(allRules
      .filter(r => r.application === appSelect.value)
      .map(r => r.sub_module)
    );
    setOptions(subSelect, subs, prevSub);

    // Rule types for selected app/sub
    const types = uniq(allRules
      .filter(r => r.application === appSelect.value && r.sub_module === subSelect.value)
      .map(r => r.rule_type)
    );
    setOptions(typeSelect, types, prevType);

    // Rule names for selected app/sub/type
    const names = uniq(getFilteredRules().map(r => r.rule_name));
    setOptions(ruleSelect, names, prevName);

    updateContext();
  }

  function selectCurrentRule() {
    const name = ruleSelect.value;
    const candidates = getFilteredRules();
    selectedRule = candidates.find(r => r.rule_name === name) || null;

    if (!selectedRule) {
      ruleDef.value = '';
      ruleDesc.value = '';
      updateContext();
      return;
    }

    // Populate from Redis fields
    ruleDef.value = selectedRule.rule_def || '';
    ruleDesc.value = selectedRule.rule_desc || ''; // if you store it in Redis
    updateContext();

    // Auto-generate description if missing
    if (ruleDef.value.trim() && !ruleDesc.value.trim()) {
      generateDescription(ruleDef.value, false);
    }
  }

  function generateDescription(definition, force=false) {
    if (!definition || !definition.trim()) return;

    const genId = ++currentGenId;
    ruleDesc.value = force ? 'Regenerating description...' : 'Generating description...';
    regenerateBtn.disabled = true;

    fetch('/api/generate-description', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ definition, force })
    })
    .then(r => r.json())
    .then(data => {
      if (genId !== currentGenId) return;
      const desc = (data && data.description) ? data.description.trim() : '';
      ruleDesc.value = desc;

      // keep local cache in sync
      if (selectedRule) selectedRule.rule_desc = desc;
    })
    .catch(err => {
      if (genId !== currentGenId) return;
      console.warn('LLM description fetch failed:', err);
      ruleDesc.value = '';
    })
    .finally(() => {
      regenerateBtn.disabled = false;
    });
  }

  async function loadRulesFromServer() {
    const res = await fetch('/api/rules');
    const data = await res.json();
    allRules = (data && data.rules) ? data.rules : [];
  }

  // Event listeners
  appSelect.addEventListener('change', () => {
    repopulateSelectors();
    selectCurrentRule();
  });

  subSelect.addEventListener('change', () => {
    repopulateSelectors();
    selectCurrentRule();
  });

  typeSelect.addEventListener('change', () => {
    repopulateSelectors();
    selectCurrentRule();
  });

  ruleSelect.addEventListener('change', () => {
    selectCurrentRule();
  });

  // Save: write description back to Redis (requires backend endpoint)
  saveBtn.addEventListener('click', async (e) => {
    e.preventDefault();
    if (!selectedRule || !selectedRule.rule_id) {
      alert('No rule selected.');
      return;
    }

    const payload = {
      description: ruleDesc.value || ''
    };

    // This endpoint must exist on Flask (see note below)
    const resp = await fetch(`/api/rules/${selectedRule.rule_id}/description`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (resp.ok) {
      alert('Saved to Redis.');
    } else {
      const err = await resp.json().catch(() => ({}));
      alert('Save failed: ' + (err.error || resp.status));
    }
  });

  regenerateBtn.addEventListener('click', (e) => {
    e.preventDefault();
    if (!ruleDef.value || !ruleDef.value.trim()) return;
    generateDescription(ruleDef.value, true);
  });

  // Init
  (async function init() {
    await loadRulesFromServer();
    repopulateSelectors();
    selectCurrentRule();
  })();
</script>


  </body>
</html>
