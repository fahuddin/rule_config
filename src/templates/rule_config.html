<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Rule Maintenance</title>
    <style>
      :root{
        --bg:#ffffff;--card:#ffffff;--accent:#0f172a;--muted:#6b7280;--border:#e5e7eb;
        --soft:#f8fafc;--warn:#b45309;--good:#065f46
      }
      html,body{height:100%}
      body{
        margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;
        background:var(--bg);color:#000;display:flex;align-items:flex-start;justify-content:center;padding:32px
      }
      .container{width:1020px;max-width:96%}
      .card{
        background:var(--card);border-radius:12px;padding:22px;
        box-shadow:0 6px 18px rgba(0,0,0,0.06);border:1px solid var(--border)
      }
      h1{margin:0 0 8px;font-size:20px}
      p.lead{margin:0 0 18px;color:var(--muted)}
      .grid{display:grid;grid-template-columns:1fr 420px;gap:20px;align-items:start}
      @media (max-width:920px){.grid{grid-template-columns:1fr}}
      .form-row{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:12px}
      label.field{font-size:0.85rem;color:var(--muted);display:block;margin-bottom:6px}
      select,input[type=text],textarea{
        padding:10px;border:1px solid var(--border);border-radius:8px;width:100%;box-sizing:border-box;
        background:#fff
      }
      textarea{resize:vertical}
      .section{background:#fff;padding:12px;border-radius:10px;border:1px solid var(--border)}
      .section h3{margin:0 0 8px;font-size:14px}
      .muted{color:var(--muted);font-size:0.9rem}
      .toolbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px}
      .pill{
        display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;
        border:1px solid var(--border);background:#fff;font-size:12px;color:#111
      }
      .pill strong{font-weight:600}
      .footer{display:flex;justify-content:space-between;align-items:center;margin-top:14px;gap:10px;flex-wrap:wrap}
      button{
        padding:10px 14px;border-radius:8px;border:1px solid var(--border);
        background:#fff;cursor:pointer
      }
      button.primary{background:var(--accent);color:#fff;border-color:transparent}
      button:disabled{opacity:.55;cursor:not-allowed}
      .row-actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
      .hint{background:var(--soft);border:1px dashed var(--border);padding:10px;border-radius:10px}
      .status{font-size:12px;color:var(--muted)}
      .status.ok{color:var(--good)}
      .status.warn{color:var(--warn)}
      .small{font-size:12px}
      .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    </style>
  </head>

  <body>
    <div class="container">
      <div class="card">
        <div class="toolbar">
          <div>
            <h1 style="margin:0">Rule Maintenance</h1>
            <p class="lead">Browse rules from Redis, edit details, and run agent modes to generate outputs.</p>
          </div>
          <div class="row-actions">
            <span class="pill"><strong>API</strong> <span class="mono">/api/rules</span></span>
            <button id="refreshBtn" title="Reload from server">Refresh</button>
          </div>
        </div>

        <div class="grid">
          <!-- LEFT -->
          <div>
            <div class="section">
              <h3>Application / Module</h3>
              <div class="form-row">
                <div>
                  <label class="field">Application</label>
                  <select id="appSelect"></select>
                </div>
                <div>
                  <label class="field">Sub-module</label>
                  <select id="subSelect"></select>
                </div>
              </div>

              <h3 style="margin-top:12px">Rule Type &amp; Rule</h3>
              <div class="form-row">
                <div>
                  <label class="field">Rule Type</label>
                  <select id="typeSelect"></select>
                </div>
                <div>
                  <label class="field">Rule Name</label>
                  <select id="ruleSelect"></select>
                </div>
              </div>
            </div>

            <div style="margin-top:12px" class="section">
              <h3>Rule Details</h3>

              <div class="form-row" style="grid-template-columns:1fr 1fr">
                <div>
                  <label class="field">Rule ID</label>
                  <input id="ruleId" type="text" disabled />
                </div>
                <div>
                  <label class="field">Rule Name</label>
                  <input id="ruleName" type="text" disabled />
                </div>
              </div>

              <div style="margin-bottom:8px">
                <label class="field">Rule Definition</label>
                <textarea id="ruleDef" rows="7" placeholder="Rule definition (MVEL / expression)"></textarea>
              </div>

              <div style="margin-bottom:8px">
                <label class="field">Rule Description / Output</label>
                <textarea id="ruleDesc" rows="4" placeholder="Agent output or saved description"></textarea>
              </div>

              <div class="footer">
                <div>
                  <div class="status" id="statusText">Ready.</div>
                  <div class="small muted">
                    Save writes only <span class="mono">rule_desc</span> via
                    <span class="mono">POST /api/rules/&lt;id&gt;/description</span>.
                  </div>
                </div>

                <div class="row-actions">
                  <button class="primary" id="saveBtn">Save Description</button>

                  <div style="min-width:180px">
                    <label class="field" style="margin-bottom:6px">Agent mode</label>
                    <select id="modeSelect">
                      <option value="explain">explain</option>
                      <option value="diff">diff</option>
                      <option value="verify">verify</option>
                      <option value="tests">tests</option>
                    </select>
                  </div>

                  <button id="agentBtn">Run Agent</button>
                  <button id="regenerateBtn" title="Force regenerate (no cache)">Regenerate</button>
                </div>
              </div>
            </div>
          </div>

          <!-- RIGHT -->
          <div>
            <div class="section">
              <h3>Selected Context</h3>
              <div style="margin-top:8px">
                <p><strong>Application:</strong> <span id="ctxApp">-</span></p>
                <p><strong>Sub-module:</strong> <span id="ctxSub">-</span></p>
                <p><strong>Rule Type:</strong> <span id="ctxType">-</span></p>
                <p><strong>Rule Name:</strong> <span id="ctxName">-</span></p>
              </div>
            </div>

            <div style="margin-top:12px" class="section">
              <h3>Agent Modes</h3>
              <div class="hint muted">
                <div><strong>explain</strong>: user-friendly description of the rule.</div>
                <div style="margin-top:6px"><strong>diff</strong>: highlight changes between current vs saved (if your agent supports it).</div>
                <div style="margin-top:6px"><strong>verify</strong>: sanity-check and return issues/suggestions.</div>
                <div style="margin-top:6px"><strong>tests</strong>: propose test cases for the rule.</div>
                <div style="margin-top:10px" class="small">
                  Calls <span class="mono">POST /api/generate-description?mode=&lt;mode&gt;</span> with JSON
                  <span class="mono">{ definition, model, force }</span>.
                </div>
              </div>
            </div>

            <div style="margin-top:12px" class="section">
              <h3>Help</h3>
              <div class="muted">
                Pick Application/Sub-module/Type to filter rules. Run the agent for explain/diff/verify/tests.
                Save persists the current text in the output box as <span class="mono">rule_desc</span>.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Elements
      const appSelect = document.getElementById('appSelect');
      const subSelect = document.getElementById('subSelect');
      const typeSelect = document.getElementById('typeSelect');
      const ruleSelect = document.getElementById('ruleSelect');

      const ctxApp = document.getElementById('ctxApp');
      const ctxSub = document.getElementById('ctxSub');
      const ctxType = document.getElementById('ctxType');
      const ctxName = document.getElementById('ctxName');

      const ruleId = document.getElementById('ruleId');
      const ruleName = document.getElementById('ruleName');
      const ruleDef = document.getElementById('ruleDef');
      const ruleDesc = document.getElementById('ruleDesc');

      const modeSelect = document.getElementById('modeSelect');
      const saveBtn = document.getElementById('saveBtn');
      const regenerateBtn = document.getElementById('regenerateBtn');
      const agentBtn = document.getElementById('agentBtn');
      const refreshBtn = document.getElementById('refreshBtn');
      const statusText = document.getElementById('statusText');

      // Data
      let allRules = [];
      let selectedRule = null;
      let currentGenId = 0;

      const model = "llama3.1"; // default; add a selector if needed

      // Helpers
      const uniq = (arr) => [...new Set(arr.filter(v => String(v || '').trim() !== ''))];

      function setStatus(msg, kind="") {
        statusText.className = "status " + (kind || "");
        statusText.textContent = msg;
      }

      function setOptions(selectEl, values, preferredValue = null) {
        selectEl.innerHTML = '';
        values.forEach(v => {
          const opt = document.createElement('option');
          opt.value = v;
          opt.textContent = v;
          selectEl.appendChild(opt);
        });
        if (preferredValue && values.includes(preferredValue)) {
          selectEl.value = preferredValue;
        } else if (values.length) {
          selectEl.selectedIndex = 0;
        }
      }

      function updateContext() {
        ctxApp.textContent = appSelect.value || '-';
        ctxSub.textContent = subSelect.value || '-';
        ctxType.textContent = typeSelect.value || '-';
        ctxName.textContent = ruleSelect.value || '-';
      }

      function getFilteredRules() {
        const app = appSelect.value;
        const sub = subSelect.value;
        const typ = typeSelect.value;
        return allRules.filter(r =>
          (!app || r.application === app) &&
          (!sub || r.sub_module === sub) &&
          (!typ || r.rule_type === typ)
        );
      }

      function repopulateSelectors() {
        const prevApp = appSelect.value;
        const prevSub = subSelect.value;
        const prevType = typeSelect.value;
        const prevName = ruleSelect.value;

        const apps = uniq(allRules.map(r => r.application));
        setOptions(appSelect, apps, prevApp);

        const subs = uniq(allRules
          .filter(r => r.application === appSelect.value)
          .map(r => r.sub_module)
        );
        setOptions(subSelect, subs, prevSub);

        const types = uniq(allRules
          .filter(r => r.application === appSelect.value && r.sub_module === subSelect.value)
          .map(r => r.rule_type)
        );
        setOptions(typeSelect, types, prevType);

        const names = uniq(getFilteredRules().map(r => r.rule_name));
        setOptions(ruleSelect, names, prevName);

        updateContext();
      }

      function selectCurrentRule() {
        const name = ruleSelect.value;
        const candidates = getFilteredRules();
        selectedRule = candidates.find(r => r.rule_name === name) || null;

        if (!selectedRule) {
          ruleId.value = '';
          ruleName.value = '';
          ruleDef.value = '';
          ruleDesc.value = '';
          updateContext();
          setStatus("No rule selected.", "warn");
          return;
        }

        ruleId.value = selectedRule.rule_id || '';
        ruleName.value = selectedRule.rule_name || '';
        ruleDef.value = selectedRule.rule_def || '';
        ruleDesc.value = selectedRule.rule_desc || '';

        updateContext();
        setStatus("Loaded rule from Redis.", "ok");

        // Auto-generate description if missing
        if (ruleDef.value.trim() && !ruleDesc.value.trim()) {
          generateAgentOutput(ruleDef.value, false, "explain");
        }
      }

      async function loadRulesFromServer() {
        setStatus("Loading rules...", "");
        const res = await fetch('/api/rules');
        const data = await res.json();
        allRules = (data && data.rules) ? data.rules : [];
        setStatus(`Loaded ${allRules.length} rules.`, "ok");
      }

      function generateAgentOutput(definition, force=false, modeOverride=null) {
        if (!definition || !definition.trim()) return;

        const genId = ++currentGenId;
        const modeToUse = modeOverride || modeSelect.value || "explain";

        ruleDesc.value = force ? "Regenerating..." : "Generating...";
        regenerateBtn.disabled = true;
        agentBtn.disabled = true;

        setStatus(`Agent running in "${modeToUse}" mode...`, "");

        // Flask reads mode from request.form in your snippet, but easiest is querystring.
        fetch(`/api/generate-description?mode=${encodeURIComponent(modeToUse)}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({mode: modeToUse, definition, model, force })
        })
        .then(r => r.json())
        .then(data => {
          if (genId !== currentGenId) return;
          const out = (data && data.description) ? String(data.description).trim() : '';
          ruleDesc.value = out;

          if (selectedRule) selectedRule.rule_desc = out;

          setStatus("Agent finished.", "ok");
        })
        .catch(err => {
          if (genId !== currentGenId) return;
          console.warn('Agent call failed:', err);
          ruleDesc.value = '';
          setStatus("Agent failed. Check server logs.", "warn");
        })
        .finally(() => {
          regenerateBtn.disabled = false;
          agentBtn.disabled = false;
        });
      }

      // Events: selectors
      appSelect.addEventListener('change', () => { repopulateSelectors(); selectCurrentRule(); });
      subSelect.addEventListener('change', () => { repopulateSelectors(); selectCurrentRule(); });
      typeSelect.addEventListener('change', () => { repopulateSelectors(); selectCurrentRule(); });
      ruleSelect.addEventListener('change', () => { selectCurrentRule(); });

      // Refresh
      refreshBtn.addEventListener('click', async () => {
        await loadRulesFromServer();
        repopulateSelectors();
        selectCurrentRule();
      });

      // Save description (per your Flask endpoint)
      saveBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        if (!selectedRule || !selectedRule.rule_id) {
          alert('No rule selected.');
          return;
        }

        const desc = (ruleDesc.value || '').trim();
        if (!desc) {
          alert('Description/output is empty.');
          return;
        }

        setStatus("Saving description...", "");
        const resp = await fetch(`/api/rules/${encodeURIComponent(selectedRule.rule_id)}/description`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ description: desc })
        });

        if (resp.ok) {
          setStatus("Saved to Redis.", "ok");
          selectedRule.rule_desc = desc;
        } else {
          const err = await resp.json().catch(() => ({}));
          setStatus("Save failed.", "warn");
          alert('Save failed: ' + (err.error || resp.status));
        }
      });

      // Run agent
      agentBtn.addEventListener('click', (e) => {
        e.preventDefault();
        if (!ruleDef.value || !ruleDef.value.trim()) return;
        generateAgentOutput(ruleDef.value, false, modeSelect.value);
      });

      // Force regenerate (no cache)
      regenerateBtn.addEventListener('click', (e) => {
        e.preventDefault();
        if (!ruleDef.value || !ruleDef.value.trim()) return;
        generateAgentOutput(ruleDef.value, true, modeSelect.value);
      });

      // Init
      (async function init() {
        await loadRulesFromServer();
        repopulateSelectors();
        selectCurrentRule();
      })();
    </script>
  </body>
</html>
